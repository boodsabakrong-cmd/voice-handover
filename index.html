<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .recording-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .recording-button.recording {
            animation: pulse-red 1.5s infinite;
            background-color: #ef4444; /* Red 500 */
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .file-list {
            background-color: #f3f4f6;
            border-radius: 8px;
            padding: 1rem;
        }
        .audio-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .audio-item:last-child {
            border-bottom: none;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-lg">
        <h1 class="text-2xl font-bold text-center text-blue-800 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h1>
        <p class="text-xs text-red-500 text-center mb-4 font-semibold">
            üîê **‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: PASS999** (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ) üîê
        </p>

        <div class="space-y-4">

            <!-- 1. Metadata Inputs -->
            <div class="space-y-2">
                <label for="senderName" class="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£:</label>
                <input type="text" id="senderName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô.‡∏™. ‡∏≠‡∏£‡∏∏‡∏ì‡∏£‡∏±‡∏ï‡∏ô‡πå (‡∏ä)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                
                <label for="receiverName" class="block text-sm font-medium text-gray-700 pt-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏£:</label>
                <input type="text" id="receiverName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô.‡∏™. ‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏†‡∏≤ (‡∏ö)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                
                <label for="shiftType" class="block text-sm font-medium text-gray-700 pt-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ß‡∏£:</label>
                <select id="shiftType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="‡πÄ‡∏ä‡πâ‡∏≤ -> ‡∏ö‡πà‡∏≤‡∏¢">‡πÄ‡∏ä‡πâ‡∏≤ ‚Üí ‡∏ö‡πà‡∏≤‡∏¢</option>
                    <option value="‡∏ö‡πà‡∏≤‡∏¢ -> ‡∏î‡∏∂‡∏Å">‡∏ö‡πà‡∏≤‡∏¢ ‚Üí ‡∏î‡∏∂‡∏Å</option>
                    <option value="‡∏î‡∏∂‡∏Å -> ‡πÄ‡∏ä‡πâ‡∏≤">‡∏î‡∏∂‡∏Å ‚Üí ‡πÄ‡∏ä‡πâ‡∏≤</option>
                    <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
            </div>
            
            <!-- Password Input -->
            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                <label for="reportPassword" class="block text-sm font-medium text-yellow-800">üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ:</label>
                <input type="text" id="reportPassword" value="PASS999" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1234 (‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°)" class="w-full p-3 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm mt-1">
                <p class="text-xs text-yellow-700 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ</p>
            </div>

            <hr class="my-4">

            <!-- 2. Voice Recording Section -->
            <div class="text-center bg-blue-50 p-4 rounded-lg">
                <p class="text-lg font-semibold text-blue-800 mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏õ (Segment)</p>
                
                <label for="patientBed" class="block text-sm font-medium text-gray-700 pt-2 text-left">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡∏µ‡∏¢‡∏á:</label>
                <input type="text" id="patientBed" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12/1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 mb-3">

                <label for="patientName" class="block text-sm font-medium text-gray-700 pt-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
                <input type="text" id="patientName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏±‡∏Å‡∏ä‡∏≤‡∏ï‡∏¥" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 mb-4">
                
                <button id="recordBtn" class="recording-button bg-red-500 text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto text-sm font-bold shadow-xl">
                    <span id="recordStatus">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </button>
                <div id="recordingTimer" class="mt-2 text-gray-600">00:00</div>
                <div id="audioStatus" class="mt-3 text-sm font-medium text-gray-500"></div>
                
                <button id="saveClipBtn" class="mt-4 w-full py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150 disabled:opacity-50" disabled>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                </button>
            </div>
            
            <!-- 3. Recorded Clips List -->
            <div id="clipsContainer" class="file-list mt-4 hidden">
                <p class="font-semibold text-gray-700 mb-2">üíæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏õ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:</p>
                <div id="clipsList" class="space-y-2">
                    <!-- Audio clips will be inserted here -->
                </div>
            </div>

            <!-- 4. LINE API Setup (NOW EDITABLE AND EMPTY) -->
            <hr class="my-4">
            <div class="space-y-2 bg-purple-50 p-4 rounded-lg border border-purple-200">
                <p class="text-sm font-bold text-purple-800">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE API (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)</p>
                <label for="lineAccessToken" class="block text-sm font-medium text-gray-700">Channel Access Token:</label>
                <!-- **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**: ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏£‡∏±‡∏ö Token ‡∏à‡∏£‡∏¥‡∏á -->
                <input type="text" id="lineAccessToken" 
                       value="" 
                       placeholder="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Token ‡∏Ç‡∏≠‡∏á LINE Bot (Messaging API)" 
                       class="w-full p-3 border border-purple-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-800 bg-white text-xs">
                
                <label for="lineRecipientId" class="block text-sm font-medium text-gray-700 pt-2">Group ID ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á:</label>
                <!-- **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**: ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏£‡∏±‡∏ö Group ID ‡∏à‡∏£‡∏¥‡∏á -->
                <input type="text" id="lineRecipientId" 
                       value="" 
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô Cxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                       class="w-full p-3 border border-purple-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-800 bg-white text-xs">
                <p class="text-xs text-purple-700 mt-1">‚ö†Ô∏è **‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Channel Access Token ‡πÅ‡∏•‡∏∞ Group ID ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô**</p>
            </div>

            <!-- 5. Send Button -->
            <button id="sendBtn" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-150 disabled:opacity-50" disabled>
                ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ)
            </button>
            <div id="messageBox" class="mt-3 p-3 text-center rounded-lg text-sm hidden"></div>
        </div>
    </div>

    <!-- Edit Clip Modal -->
    <div id="editModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition duration-300 translate-y-10">
            <h2 class="text-xl font-bold text-blue-700 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏¥‡∏õ</h2>
            <p id="modalClipName" class="text-md font-semibold text-gray-600 mb-3"></p>
            
            <label for="modalBed" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡∏µ‡∏¢‡∏á:</label>
            <input type="text" id="modalBed" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 mb-3">
            
            <label for="modalName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
            <input type="text" id="modalName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 mb-4">
            
            <div class="flex justify-end space-x-3">
                <button id="closeModalBtn" class="py-2 px-4 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="saveModalBtn" class="py-2 px-4 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const recordStatus = document.getElementById('recordStatus');
        const recordingTimer = document.getElementById('recordingTimer');
        const audioStatus = document.getElementById('audioStatus');
        const saveClipBtn = document.getElementById('saveClipBtn');
        const sendBtn = document.getElementById('sendBtn');
        const senderNameInput = document.getElementById('senderName');
        const receiverNameInput = document.getElementById('receiverName');
        const shiftTypeInput = document.getElementById('shiftType');
        const patientBedInput = document.getElementById('patientBed'); 
        const patientNameInput = document.getElementById('patientName'); 
        const reportPasswordInput = document.getElementById('reportPassword'); 
        const lineAccessTokenInput = document.getElementById('lineAccessToken');
        const lineRecipientIdInput = document.getElementById('lineRecipientId');
        const clipsContainer = document.getElementById('clipsContainer');
        const clipsList = document.getElementById('clipsList');
        const messageBox = document.getElementById('messageBox');
        
        // Modal Elements
        const editModal = document.getElementById('editModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const saveModalBtn = document.getElementById('saveModalBtn');
        const modalClipName = document.getElementById('modalClipName');
        const modalBedInput = document.getElementById('modalBed');
        const modalNameInput = document.getElementById('modalName');

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime;
        let timerInterval;
        let recordedClips = []; 
        let currentBlob = null; 
        let currentEditIndex = null; 

        // IMPORTANT: In a real environment, this URL would be generated after uploading the audio file 
        // to a storage service (like Google Cloud Storage or Firebase Storage).
        const SIMULATED_FILE_BASE_URL = 'https://storage.google.com/handoff-voice/clip-';

        // --- Utility Functions ---
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
            recordingTimer.textContent = formatTime(elapsedTime);
        }

        function checkInputs() {
            const accessToken = lineAccessTokenInput.value.trim();
            const recipientId = lineRecipientIdInput.value.trim();
            const sender = senderNameInput.value.trim();
            const receiver = receiverNameInput.value.trim();
            const password = reportPasswordInput.value.trim(); 

            // The button is enabled only if there is at least one clip AND all required fields are filled.
            if (recordedClips.length > 0 && accessToken && recipientId && sender && receiver && password) {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        // --- Recording Logic ---
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                currentBlob = null;
                audioStatus.textContent = '';
                messageBox.classList.add('hidden'); 
                saveClipBtn.disabled = true;

                if (!patientBedInput.value.trim() || !patientNameInput.value.trim()) {
                    showMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                    stream.getTracks().forEach(track => track.stop());
                    return;
                }

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    currentBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    stream.getTracks().forEach(track => track.stop());
                    
                    audioStatus.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${recordingTimer.textContent}`;
                    saveClipBtn.disabled = false;
                };

                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('recording', 'bg-red-700');
                recordStatus.textContent = '‡∏´‡∏¢‡∏∏‡∏î';

                recordingStartTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);

            } catch (err) {
                console.error('Microphone access denied or error:', err);
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('recording', 'bg-red-700');
                recordStatus.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                clearInterval(timerInterval);
            }
        }

        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                // Ensure inputs are checked before recording starts
                startRecording();
            }
        });
        
        // --- Clip Management Logic ---

        function saveCurrentClip() {
            if (!currentBlob) return;

            saveClipBtn.disabled = true;
            audioStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

            setTimeout(() => {
                const timestamp = new Date().getTime();
                const mockUrl = `${SIMULATED_FILE_BASE_URL}${timestamp}.mp3?t=${timestamp}`; 
                const duration = recordingTimer.textContent;

                const newClip = {
                    url: mockUrl,
                    duration: duration,
                    bed: patientBedInput.value.trim(),
                    name: patientNameInput.value.trim(),
                };

                recordedClips.push(newClip);
                renderClipsList();
                
                audioStatus.textContent = `‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß`;
                recordingTimer.textContent = '00:00';
                
                // Clear patient info for next clip
                patientBedInput.value = '';
                patientNameInput.value = '';

                checkInputs();

            }, 1000);
        }

        saveClipBtn.addEventListener('click', saveCurrentClip);

        function renderClipsList() {
            clipsList.innerHTML = '';
            if (recordedClips.length === 0) {
                clipsContainer.classList.add('hidden');
                return;
            }

            clipsContainer.classList.remove('hidden');
            
            recordedClips.forEach((clip, index) => {
                const item = document.createElement('div');
                item.className = 'audio-item flex-col items-start space-y-2';
                item.innerHTML = `
                    <div class="w-full flex justify-between items-center">
                        <div class="text-sm font-semibold text-blue-800">
                            ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà ${index + 1}: ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${clip.bed || 'N/A'} - ${clip.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                        </div>
                        <div class="flex space-x-2">
                            <button data-index="${index}" class="edit-clip-btn text-blue-500 hover:text-blue-700 text-xs font-bold p-1 rounded transition duration-150">
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button data-index="${index}" class="delete-clip-btn text-red-500 hover:text-red-700 text-xs font-bold p-1 rounded transition duration-150">
                                ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                    <audio src="${clip.url}" controls class="w-full h-8"></audio>
                    <div class="w-full text-xs text-gray-500">
                        ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${clip.duration} | ‡∏•‡∏¥‡∏á‡∏Å‡πå: <span class="text-xs truncate text-gray-400">${clip.url.substring(0, 30)}...</span>
                    </div>
                `;
                clipsList.appendChild(item);
            });

            document.querySelectorAll('.delete-clip-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    deleteClip(index);
                });
            });

            document.querySelectorAll('.edit-clip-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    openEditModal(index);
                });
            });
        }

        function deleteClip(index) {
            recordedClips.splice(index, 1);
            renderClipsList();
            checkInputs();
            showMessage('‡∏•‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }

        // --- Modal Functions ---
        function openEditModal(index) {
            currentEditIndex = index;
            const clip = recordedClips[index];
            
            modalClipName.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà ${index + 1} (${clip.duration})`;
            modalBedInput.value = clip.bed;
            modalNameInput.value = clip.name;

            editModal.classList.remove('opacity-0', 'pointer-events-none');
            editModal.querySelector('.transform').classList.remove('translate-y-10');
        }

        function closeEditModal() {
            editModal.classList.add('opacity-0', 'pointer-events-none');
            editModal.querySelector('.transform').classList.add('translate-y-10');
            currentEditIndex = null;
        }

        saveModalBtn.addEventListener('click', () => {
            if (currentEditIndex !== null) {
                const bed = modalBedInput.value.trim();
                const name = modalNameInput.value.trim();
                
                if (!bed || !name) {
                    showMessage('‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', 'error');
                    return;
                }

                recordedClips[currentEditIndex].bed = bed;
                recordedClips[currentEditIndex].name = name;
                
                renderClipsList();
                closeEditModal();
                showMessage('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß');
            }
        });

        closeModalBtn.addEventListener('click', closeEditModal);
        
        editModal.addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });


        // --- LINE Messaging API Logic ---

        async function sendHandoffReport() {
            sendBtn.disabled = true;

            const accessToken = lineAccessTokenInput.value.trim(); 
            const recipientId = lineRecipientIdInput.value.trim(); 
            const sender = senderNameInput.value.trim();
            const receiver = receiverNameInput.value.trim();
            const shiftType = shiftTypeInput.value;
            const reportPassword = reportPasswordInput.value.trim(); 

            if (!accessToken || !recipientId || recordedClips.length === 0 || !sender || !receiver || !reportPassword) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
                sendBtn.disabled = false;
                return;
            }

            // Generate detailed list of masked URLs for the LINE message
            // We append a query parameter '?p=PASSWORD' to simulate security
            let audioLinks = recordedClips.map((clip, index) => 
                `üìå ${index + 1}. [‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${clip.bed} - ${clip.name}] (${clip.duration})\n  üîó ${clip.url}?p=${reportPassword}`
            ).join('\n\n');

            // Construct the LINE message object
            const messageText = `
üì¢ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£ (${shiftType})
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏±‡∏á: ${reportPassword}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£: ${sender}
ü§ù ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏£: ${receiver}
üóìÔ∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á: ${new Date().toLocaleString('th-TH', { hour12: false })}

---
üéôÔ∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (${recordedClips.length} ‡∏Ñ‡∏•‡∏¥‡∏õ)
${audioLinks}
---

(‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
`;
            
            const payload = {
                to: recipientId,
                messages: [{
                    type: 'text',
                    text: messageText
                }]
            };

            const apiUrl = 'https://api.line.me/v2/bot/message/push';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.status === 200) {
                    showMessage('‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)', 'success');
                    // Clear recorded clips after sending
                    recordedClips = [];
                    renderClipsList();
                    senderNameInput.value = '';
                    receiverNameInput.value = '';
                } else {
                    const errorData = await response.json();
                    console.error('LINE API Error Response:', errorData);
                    // Check for specific error message to guide user
                    let errorMessage = '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Channel Access Token ‡∏´‡∏£‡∏∑‡∏≠ Group ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    if (errorData.message && errorData.message.includes('Invalid access token')) {
                        errorMessage = '‚ùå Channel Access Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Token ‡πÉ‡∏´‡∏°‡πà';
                    } else if (errorData.message && errorData.message.includes('Invalid userId')) {
                        errorMessage = '‚ùå Group ID ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÉ‡∏´‡∏°‡πà';
                    }
                    showMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: ${errorMessage}`, 'error');
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢', 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        sendBtn.addEventListener('click', sendHandoffReport);

        // Check form state when user types 
        senderNameInput.addEventListener('input', checkInputs);
        receiverNameInput.addEventListener('input', checkInputs);
        reportPasswordInput.addEventListener('input', checkInputs); 
        lineAccessTokenInput.addEventListener('input', checkInputs); // New listener
        lineRecipientIdInput.addEventListener('input', checkInputs); // New listener


        // Initial setup
        checkInputs(); 
    </script>
</body>
</html>
